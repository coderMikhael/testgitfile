<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GitHub JSON – minimal</title>
<style>
  :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
  body { margin: 16px; }
  .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:10px; }
  input, button { padding:6px 10px; border:1px solid #ccc; border-radius:10px; }
  input { min-width: 150px; }
  button { background:#fff; cursor:pointer; }
  button:disabled { opacity:.5; cursor:not-allowed; }
  textarea { width:100%; height:60vh; padding:10px; border:1px solid #ccc; border-radius:10px;
             font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  small { color:#666; }
</style>
</head>
<body>
  <div class="row">
    <input id="owner" placeholder="owner" />
    <input id="repo" placeholder="repo" />
    <input id="branch" placeholder="branch" />
    <input id="path" placeholder="path/to/file.json" style="min-width:260px" />
  </div>
  <div class="row">
    <input id="token" placeholder="GitHub token (repo contents:rw)" type="password" style="min-width:320px" />
    <label><input type="checkbox" id="remember" /> remember token locally</label>
    <button id="loadBtn">Load</button>
    <button id="saveBtn" disabled>Save</button>
    <span id="status"><small>idle</small></span>
  </div>
  <textarea id="editor" placeholder='Open a JSON file or paste JSON here...'></textarea>

<script>
/* ---- defaults (you can change these) ---- */
document.getElementById('owner').value  = 'coderMikhael';
document.getElementById('repo').value   = 'testgitfile';
document.getElementById('branch').value = 'main';
document.getElementById('path').value   = 'config.json'; // or data/att-billing.json

/* ---- elements ---- */
const ownerEl = document.getElementById('owner');
const repoEl  = document.getElementById('repo');
const branchEl= document.getElementById('branch');
const pathEl  = document.getElementById('path');
const tokenEl = document.getElementById('token');
const rememberEl = document.getElementById('remember');
const loadBtn = document.getElementById('loadBtn');
const saveBtn = document.getElementById('saveBtn');
const statusEl= document.getElementById('status');
const editor  = document.getElementById('editor');

/* ---- local token remember (optional) ---- */
const TOKEN_KEY = 'gh-json-editor:token';
const remembered = localStorage.getItem(TOKEN_KEY);
if (remembered) { tokenEl.value = remembered; rememberEl.checked = true; }

/* ---- helpers ---- */
function setStatus(msg){ statusEl.innerHTML = '<small>'+msg+'</small>'; }
function isJson(t){ try{ JSON.parse(t); return true; } catch { return false; } }
function pretty(t){ try{ return JSON.stringify(JSON.parse(t), null, 2); } catch { return t; } }

// base64 (utf8-safe)
function b64encodeUtf8(str) {
  return btoa(unescape(encodeURIComponent(str)));
}
function b64decodeUtf8(b64) {
  return decodeURIComponent(escape(atob(b64)));
}

/* ---- state ---- */
let currentSha = null;

/* ---- API calls ---- */
function ghHeaders(token){
  return {
    'Accept': 'application/vnd.github+json',
    'Authorization': 'Bearer ' + token,
    'X-GitHub-Api-Version': '2022-11-28'
  };
}

async function ghGetFile({owner, repo, path, ref, token}) {
  const url = `https://api.github.com/repos/${encodeURIComponent(owner)}/${encodeURIComponent(repo)}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(ref)}`;
  const res = await fetch(url, { headers: ghHeaders(token) });
  if (!res.ok) throw new Error(`GET ${res.status}`);
  return await res.json(); // {content(base64), sha, path, ...}
}

async function ghPutFile({owner, repo, path, message, contentB64, sha, branch, token}) {
  const url = `https://api.github.com/repos/${encodeURIComponent(owner)}/${encodeURIComponent(repo)}/contents/${encodeURIComponent(path)}`;
  const body = JSON.stringify({ message, content: contentB64, sha, branch });
  const res = await fetch(url, { method: 'PUT', headers: {...ghHeaders(token), 'Content-Type':'application/json'}, body });
  if (!res.ok) throw new Error(`PUT ${res.status}: ${await res.text()}`);
  return await res.json(); // {content:{sha,...}, commit:{...}}
}

/* ---- UI handlers ---- */
loadBtn.onclick = async () => {
  try {
    const owner = ownerEl.value.trim();
    const repo  = repoEl.value.trim();
    const branch= branchEl.value.trim();
    const path  = pathEl.value.trim();
    const token = tokenEl.value.trim();

    if (!owner || !repo || !branch || !path || !token) { setStatus('fill all fields incl. token'); return; }
    if (rememberEl.checked) localStorage.setItem(TOKEN_KEY, token); else localStorage.removeItem(TOKEN_KEY);

    setStatus('loading…');
    const data = await ghGetFile({owner, repo, path, ref: branch, token});
    const text = b64decodeUtf8(data.content.replace(/\n/g,''));
    editor.value = pretty(text);
    currentSha = data.sha;
    saveBtn.disabled = false;
    setStatus(`loaded ${path}@${branch}`);
  } catch (e) {
    saveBtn.disabled = true;
    setStatus('load failed');
    console.error(e);
  }
};

saveBtn.onclick = async () => {
  try {
    const owner = ownerEl.value.trim();
    const repo  = repoEl.value.trim();
    const branch= branchEl.value.trim();
    const path  = pathEl.value.trim();
    const token = tokenEl.value.trim();
    const text  = editor.value;

    if (!isJson(text)) { setStatus('not valid JSON'); return; }
    if (!currentSha) { setStatus('load first'); return; }

    setStatus('saving…');
    const contentB64 = b64encodeUtf8(JSON.stringify(JSON.parse(text))); // tidy + encode
    const msg = `chore: update ${path} via web editor`;
    const res = await ghPutFile({owner, repo, path, message: msg, contentB64, sha: currentSha, branch, token});
    currentSha = res.content.sha; // new sha
    setStatus('saved ✔');
  } catch (e) {
    setStatus('save failed');
    console.error(e);
  }
};

/* ---- convenience: Ctrl/Cmd+S to save ---- */
window.addEventListener('keydown', (e) => {
  if ((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s') { e.preventDefault(); if (!saveBtn.disabled) saveBtn.click(); }
});
</script>
</body>
</html>
